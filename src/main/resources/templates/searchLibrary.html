<!DOCTYPE html>
<html lang="ko">
<head>
    <th:block th:replace="~{common.html}"></th:block>
    <meta property="og:type" content="website"> 
    <meta property="og:title" content="ì±…ì´ ìˆëŠ” ë„ì„œê´€ ì°¾ê¸°"> 
    <meta property="og:description" content="ISBN, ì§€ì—­ìœ¼ë¡œ ì±…ì´ ìˆëŠ” ë„ì„œê´€ì„ ì°¾ì•„ë³´ì„¸ìš”.">
    <meta property="og:url" content="https://kkidsname.com/searchLibraryPage">
    <title>ì±…ì´ ìˆëŠ” ë„ì„œê´€ ì°¾ê¸°</title>
    <script>
	    document.addEventListener('DOMContentLoaded', function () {
	        const allRegions = /*[[${regionList}]]*/ [];
	
	        const regionSelect = document.getElementById('regionCd');
	        const detailSelect = document.getElementById('dtlRegionCd');
	
	        // ê³µí†µ fetch ì²˜ë¦¬ í•¨ìˆ˜
	        function fetchRequest(query) {
	            document.getElementById('loadingBar').style.display = 'flex';
	
	            fetch('/selectLibraryPage?' + query)
	                .then(res => res.text())
	                .then(html => {
	                    document.getElementById('lib-result-table').innerHTML = html;
	                })
	                .catch(err => console.error(err))
	                .finally(() => {
	                    document.getElementById('loadingBar').style.display = 'none';
	                });
	        }
	
	        // í¼ ì œì¶œ ì‹œ ê²€ìƒ‰
	        document.getElementById('searchForm').addEventListener('submit', function (event) {
	            event.preventDefault();
	
	            const isbn = document.getElementById('isbn').value;
	            const region = regionSelect.value;
	            const dtlRegion = detailSelect.value;
	            const query = new URLSearchParams({ isbn, region, dtlRegion }).toString();
	
	            fetchRequest(query);
	        });
	
	        // í˜ì´ì§€ ë¡œë“œ ì‹œ, ê°’ì´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ê²€ìƒ‰ íŠ¸ë¦¬ê±°
	        const isbn = document.getElementById('isbn').value;
	        const region = regionSelect.value;
	        const dtlRegion = detailSelect.value;
	
	        if (isbn && region) {
	            const query = new URLSearchParams({ isbn, region, dtlRegion }).toString();
	            fetchRequest(query); // ìë™ ê²€ìƒ‰ í˜¸ì¶œ
	        }
	    });
    
        function checkLoanStatus(btn) {
            const libCode = btn.getAttribute("data-libcode");
            const isbn = btn.getAttribute("data-isbn");
            const name = btn.getAttribute("data-name");
            const addr = btn.getAttribute("data-addr");
            const tel = btn.getAttribute("data-tel");
            const lat = btn.getAttribute("data-lat");
            const lng = btn.getAttribute("data-lng");
            const closed = btn.getAttribute("data-closed");
            const operatingTime = btn.getAttribute("data-operatingtime");
    
            document.getElementById("loadingBar").style.display = "flex";
    
            fetch(`/api/bookExist?libCode=${libCode}&isbn13=${isbn}`)
                .then(res => res.json())
                .then(data => {
                    const bookInfo = data.response?.result;
                    const html = `
                        <p><strong>ë„ì„œê´€ëª…:</strong> ${name}</p>
                        <p class="map-modal-address">
                        	<strong>ì£¼ì†Œ:</strong> ${addr}
                        	<span style="margin-left: 8px;">
                            	<button onclick="copyAddress('${addr}')" title="ì£¼ì†Œ ë³µì‚¬" >ğŸ“‹</button>
                        	</span>
                    	</p>
                        <p><strong>ì „í™”ë²ˆí˜¸:</strong> ${tel}</p>
                        <p><strong>íœ´ê´€ì¼:</strong> ${closed}</p>
                        <p><strong>ìš´ì˜ì‹œê°„:</strong> ${operatingTime}</p>
                        <p><strong>ì†Œì¥ ì—¬ë¶€:</strong> ${bookInfo?.hasBook === 'Y' ? 'ì†Œì¥' : 'ë¯¸ì†Œì¥'}</p>
                        <p><strong>ëŒ€ì¶œ ê°€ëŠ¥ ì—¬ë¶€:</strong> ${bookInfo?.loanAvailable === 'Y' ? 'âœ…' : 'âŒ'}</p>
                        <p class="loan-info-note" style="margin-top: 10px;">ğŸ”” <strong>ëŒ€ì¶œ ê°€ëŠ¥ ì—¬ë¶€ëŠ” ì „ì¼ì ê¸°ì¤€</strong>ì…ë‹ˆë‹¤.</p>
                        <p><strong>ìƒì„¸ìœ„ì¹˜</p>
                    `;
                    document.getElementById('libDetailArea').innerHTML = html;
    	            // ëª¨ë‹¬ ë¨¼ì € í‘œì‹œ
    	            document.getElementById("loanModal").style.display = "block";
                    
    	            showMapInModal(addr);

                })
            .catch(err => console.error(err))
            .finally(() => {
                // ë¡œë”©ë°” ìˆ¨ê¸°ê¸°
                document.getElementById("loadingBar").style.display = "none";
            });
        }

        function showMapInModal(address) {
            const map = new naver.maps.Map('libNaverMap', {
                center: new naver.maps.LatLng(37.5665, 126.9780), // ê¸°ë³¸: ì„œìš¸
                zoom: 16
            });

            if (!address) {
                console.error("ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            naver.maps.Service.geocode({ query: address }, function (status, response) {
                if (status !== naver.maps.Service.Status.OK || response.v2.addresses.length === 0) {
                    console.error("ì£¼ì†Œ ì¢Œí‘œ ë³€í™˜ ì‹¤íŒ¨");
                    return;
                }

                const result = response.v2.addresses[0];
                const position = new naver.maps.LatLng(result.y, result.x);

                map.setCenter(position);

                const marker = new naver.maps.Marker({
                    position: position,
                    map: map
                });
                naver.maps.Event.addListener(marker, 'click', function () {
                    const searchUrl = "https://map.naver.com/p/search/" + encodeURIComponent(address);
                    window.open(searchUrl, '_blank');
                });
            });
        }

        function closeModal() {
            document.getElementById("loanModal").style.display = "none";
        }
        function copyAddress(address) {
            navigator.clipboard.writeText(address).then(() => {
                // ì„±ê³µ ì²˜ë¦¬
            }).catch(err => {
                console.error("ë³µì‚¬ ì‹¤íŒ¨:", err);
            });
        }
    </script>
</head>
<body>
<div class="container">
	<div class="top-bar">
	    <div class="top-left" th:replace="~{nav.html}"></div>
	    <div class="top-center" th:replace="~{titlebar.html :: title-bar(centerClass='search-title', titleText='ì±…ì´ ìˆëŠ” ë„ì„œê´€ ì°¾ê¸°')}"></div>
	    <div class="top-right"></div>
	</div>
	<div id="notice">
        ë„ì„œ ISBN, ì§€ì—­ìœ¼ë¡œ í•´ë‹¹ ì±…ì„ ì†Œì¥í•˜ê³  ìˆëŠ” ë„ì„œê´€ ì •ë³´ í™•ì¸
        <br><br>
        ë°ì´í„° ì¶œì²˜ : <a href="https://www.data4library.kr/" target="_blank">ë„ì„œê´€ ì •ë³´ë‚˜ë£¨ API</a>
    </div>

    <form id="searchForm">
        <div class="form-group">
    		<label for="searchIsbn">ISBN</label>
        	<input type="text" id="isbn" name="isbn" placeholder="ISBN ì…ë ¥" th:value="${isbn}" required>
		</div>
        <div class="form-group">
			<label for="searchLibRegion">ê²€ìƒ‰ ì§€ì—­</label>
			<select id="regionCd" name="regionCd" th:value="${region}">
			    <option value="">ì§€ì—­</option>
			</select>
			
			<select id="dtlRegionCd" name="dtlRegionCd" th:value="${dtlRegion}">
			    <option value="">ì„¸ë¶€ì§€ì—­</option>
			</select>
		</div>
        <div class="form-group" style="text-align: center;">
            <input type="submit" value="ê²€ìƒ‰">
        </div>
    </form>

    <div id="lib-result-table"></div>
</div>

<!-- ë¡œë”©ë°” -->
<div id="loadingBar">
    <div></div>
</div>

<script th:inline="javascript">
    // ì„œë²„ì—ì„œ ë„˜ì–´ì˜¨ regionList : List<JsCode> í˜•ì‹
    const regionData = [[${regionList}]];

    const regionCdSelect = document.getElementById('regionCd');
    const dtlRegionCdSelect = document.getElementById('dtlRegionCd');

    const selectedRegion = /*[[${region}]]*/ '';  // ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë„˜ê¸´ ì§€ì—­ ê°’
    const selectedDtlRegion = /*[[${dtlRegion}]]*/ '';  // ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë„˜ê¸´ ì„¸ë¶€ì§€ì—­ ê°’

    // ìƒìœ„ ì§€ì—­(ì¤‘ë³µ ì œê±°) ë¡œë”©
    const regionMap = new Map();
    regionData.forEach(item => {
        if (!regionMap.has(item.regionCd)) {
            regionMap.set(item.regionCd, item.regionNm);
        }
    });

    for (const [code, name] of regionMap.entries()) {
        const opt = document.createElement('option');
        opt.value = code;
        opt.textContent = name;
        if (code === selectedRegion) {
            opt.selected = true; // ì´ë¯¸ ì„ íƒëœ ê°’ì´ë©´ ì„ íƒ ì²˜ë¦¬
        }
        regionCdSelect.appendChild(opt);
    }

    // ìƒìœ„ ì§€ì—­ ì„ íƒ ì‹œ í•˜ìœ„ ì§€ì—­ ë³€ê²½
    regionCdSelect.addEventListener('change', function () {
        const selectedRegionCd = this.value;
        dtlRegionCdSelect.innerHTML = '<option value="">ì„¸ë¶€ì§€ì—­</option>';

        regionData
            .filter(item => item.regionCd === selectedRegionCd)
            .forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.dtlRegionCd;
                opt.textContent = item.dtlRegionNm;
                if (item.dtlRegionCd === selectedDtlRegion) {
                    opt.selected = true; // ì´ë¯¸ ì„ íƒëœ ì„¸ë¶€ì§€ì—­ì´ë©´ ì„ íƒ ì²˜ë¦¬
                }
                dtlRegionCdSelect.appendChild(opt);
            });
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì„¸ë¶€ì§€ì—­ ë¡œë“œ
    regionCdSelect.dispatchEvent(new Event('change'));
</script>
</body>
</html>
