<!DOCTYPE html>
<html lang="ko">
<head>
    <th:block th:replace="~{common.html}"></th:block>
    <meta property="og:type" content="website"> 
    <meta property="og:title" content="ë„ì„œ ê²€ìƒ‰ - ì›í•˜ëŠ” ì±…ì´ ìˆëŠ” ë„ì„œê´€ ì°¾ê¸°"> 
    <meta property="og:description" content="ë„ì„œ ê²€ìƒ‰ì„ í†µí•´ ì›í•˜ëŠ” ì±…ì„ ì†Œì¥í•œ ë„ì„œê´€ì„ ì°¾ì•„ë³´ì„¸ìš”. ëŒ€ì¶œ ê°€ëŠ¥ ì—¬ë¶€ë„ ì‰½ê²Œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.">
    <meta property="og:url" content="https://kkidsname.com/searchLibraryPage">
    <title>ë„ì„œ ê²€ìƒ‰ - ì›í•˜ëŠ” ì±…ì´ ìˆëŠ” ë„ì„œê´€ ì°¾ê¸°</title>
    <script>
	    document.addEventListener('DOMContentLoaded', function () {
	        const allRegions = /*[[${regionList}]]*/ [];
	
	        const regionSelect = document.getElementById('regionCd');
	        const detailSelect = document.getElementById('dtlRegionCd');
	
	        // ê³µí†µ fetch ì²˜ë¦¬ í•¨ìˆ˜
	        function fetchRequest(query) {
	            document.getElementById('loadingBar').style.display = 'flex';
	
	            fetch('/selectLibraryPage?' + query)
	                .then(res => res.text())
	                .then(html => {
	                    document.getElementById('lib-result-table').innerHTML = html;
	                })
	                .catch(err => console.error(err))
	                .finally(() => {
	                    document.getElementById('loadingBar').style.display = 'none';
	                });
	        }
	
	        // í¼ ì œì¶œ ì‹œ ê²€ìƒ‰
	        document.getElementById('searchForm').addEventListener('submit', function (event) {
	            event.preventDefault();
	
	            const isbn = document.getElementById('isbn').value;
	            const region = regionSelect.value;
	            const dtlRegion = detailSelect.value;
	            const query = new URLSearchParams({ isbn, region, dtlRegion }).toString();
	
	            fetchRequest(query);
	        });
	
	        // í˜ì´ì§€ ë¡œë“œ ì‹œ, ê°’ì´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ê²€ìƒ‰ íŠ¸ë¦¬ê±°
	        const isbn = document.getElementById('isbn').value;
	        const region = regionSelect.value;
	        const dtlRegion = detailSelect.value;
	
	        if (isbn && region) {
	            const query = new URLSearchParams({ isbn, region, dtlRegion }).toString();
	            fetchRequest(query); // ìë™ ê²€ìƒ‰ í˜¸ì¶œ
	        }
	    });
    
        function checkLoanStatus(btn) {
            const libCode = btn.getAttribute("data-libcode");
            const isbn = btn.getAttribute("data-isbn");
            const name = btn.getAttribute("data-name");
            const addr = btn.getAttribute("data-addr");
            const tel = btn.getAttribute("data-tel");
            const lat = btn.getAttribute("data-lat");
            const lng = btn.getAttribute("data-lng");
            const closed = btn.getAttribute("data-closed");
            const operatingTime = btn.getAttribute("data-operatingtime");
    
            document.getElementById("loadingBar").style.display = "flex";
    
            fetch(`/api/bookExist?libCode=${libCode}&isbn13=${isbn}`)
                .then(res => res.json())
                .then(data => {
                    const bookInfo = data.response?.result;
                    const html = `
                        <p><strong>ë„ì„œê´€ëª…:</strong> ${name}</p>
                        <p class="map-modal-address">
                        	<strong>ì£¼ì†Œ:</strong> ${addr}
                        	<span style="margin-left: 8px;">
                            	<button onclick="copyAddress('${addr}')" title="ì£¼ì†Œ ë³µì‚¬" >ğŸ“‹</button>
                        	</span>
                    	</p>
                        <p><strong>ì „í™”ë²ˆí˜¸:</strong> ${tel}</p>
                        <p><strong>íœ´ê´€ì¼:</strong> ${closed}</p>
                        <p><strong>ìš´ì˜ì‹œê°„:</strong> ${operatingTime}</p>
                        <p><strong>ì†Œì¥ ì—¬ë¶€:</strong> ${bookInfo?.hasBook === 'Y' ? 'ì†Œì¥' : 'ë¯¸ì†Œì¥'}</p>
                        <p><strong>ëŒ€ì¶œ ê°€ëŠ¥ ì—¬ë¶€:</strong> ${bookInfo?.loanAvailable === 'Y' ? 'âœ…' : 'âŒ'}</p>
                        <p class="loan-info-note" style="margin-top: 10px;">ğŸ”” <strong>ëŒ€ì¶œ ê°€ëŠ¥ ì—¬ë¶€ëŠ” ì „ì¼ì ê¸°ì¤€</strong>ì…ë‹ˆë‹¤.</p>
                        <p><strong>ìƒì„¸ìœ„ì¹˜</p>
                    `;
                    document.getElementById('libDetailArea').innerHTML = html;
    	            // ëª¨ë‹¬ ë¨¼ì € í‘œì‹œ
    	            document.getElementById("loanModal").style.display = "block";
                    
    	            showMapInModal(addr);

                })
            .catch(err => console.error(err))
            .finally(() => {
                // ë¡œë”©ë°” ìˆ¨ê¸°ê¸°
                document.getElementById("loadingBar").style.display = "none";
            });
        }

        function showMapInModal(address) {
            // ëª¨ë‹¬ì´ display: none ìƒíƒœì˜€ë‹¤ë©´, ì§€ë„ë¥¼ ë‹¤ì‹œ ë Œë”ë§í•  ìˆ˜ ìˆë„ë¡ visible ìƒíƒœ ë³´ì¥
            const mapContainer = document.getElementById('libNaverMap');
            mapContainer.innerHTML = ''; // í˜¹ì‹œ ê¸°ì¡´ ë§ˆì»¤ë‚˜ ì§€ë„ê°€ ë‚¨ì•„ìˆëŠ” ê²½ìš° ì´ˆê¸°í™”

            // ì§€ì—°í•˜ì—¬ ì§€ë„ë¥¼ í‘œì‹œ (ëª¨ë‹¬ ë³´ì´ê³  ë‚œ ì§í›„ ì‹¤í–‰)
            setTimeout(() => {
                const map = new naver.maps.Map('libNaverMap', {
                    center: new naver.maps.LatLng(37.5665, 126.9780),
                    zoom: 16
                });

                if (!address) {
                    console.error("ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                naver.maps.Service.geocode({ query: address }, function (status, response) {
                    if (status !== naver.maps.Service.Status.OK || response.v2.addresses.length === 0) {
                        console.error("ì£¼ì†Œ ì¢Œí‘œ ë³€í™˜ ì‹¤íŒ¨");
                        return;
                    }

                    const result = response.v2.addresses[0];
                    const position = new naver.maps.LatLng(result.y, result.x);

                    map.setCenter(position);
                    map.setZoom(16);

                    const marker = new naver.maps.Marker({
                        position: position,
                        map: map
                    });

                    naver.maps.Event.addListener(marker, 'click', function () {
                        const searchUrl = "https://map.naver.com/p/search/" + encodeURIComponent(address);
                        window.open(searchUrl, '_blank');
                    });

                    // Safari ëŒ€ì‘: ì¤Œ ë ˆë²¨ë¡œ ë‹¤ì‹œ ë¦¬ë Œë”ë§ ìœ ë„
                    map.setZoom(15);
                    map.setZoom(16);
                });

            }, 50); // ì§€ë„ë¥¼ ëª¨ë‹¬ì´ ë Œë”ëœ ì§í›„ ìƒì„±
        }


        function closeModal() {
            document.getElementById("loanModal").style.display = "none";
        }
        function copyAddress(address) {
            navigator.clipboard.writeText(address).then(() => {
                // ì„±ê³µ ì²˜ë¦¬
            }).catch(err => {
                console.error("ë³µì‚¬ ì‹¤íŒ¨:", err);
            });
        }

        function searchBookByKeyword() {
            const keyword = document.getElementById('keyword').value.trim();
            if (!keyword) {
                alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            document.getElementById("loadingBar").style.display = "flex";

            fetch(`/api/naverSearchBooks?query=${encodeURIComponent(keyword)}`)
                .then(res => res.json())
                .then(data => {
                    const list = data; // List<NaverBookDto>
                    const listArea = document.getElementById('bookListArea');
                    listArea.innerHTML = '';

                    if (!list || list.length === 0) {
                        document.getElementById("bookSearchModal").style.display = "block";
                        listArea.innerHTML = '<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                        return;
                    }

                    list.forEach(book => {
                        const item = document.createElement('div');
                        item.className = 'book-item';
                        item.innerHTML = `
                            <div style="display: flex; gap: 10px; align-items: flex-start;">
                                <img src="${book.image}" alt="ë„ì„œ ì´ë¯¸ì§€" style="width: 50px; height: auto; border: 1px solid #ccc;">
                                <div>
                                    <strong>${book.title}</strong><br>
                                    <span>ì €ì: ${book.author}</span><br>
                                    <span>ISBN: ${book.isbn}</span>
                                </div>
                            </div>
                        `;
                        item.addEventListener('click', () => {
                            document.getElementById('isbn').value = book.isbn;
                            closeBookModal();
                        });
                        listArea.appendChild(item);
                    });

                    document.getElementById("bookSearchModal").style.display = "block";
                })
                .catch(err => {
                    console.error(err);
                    alert("ë„ì„œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                })
                .finally(() => {
                    document.getElementById("loadingBar").style.display = "none";
                });
        }

        function closeBookModal() {
            document.getElementById("bookSearchModal").style.display = "none";
        }
        

    </script>
</head>
<body>
<div class="container">
	<div class="top-bar">
	    <div class="top-left" th:replace="~{nav.html}"></div>
	    <div class="top-center" th:replace="~{titlebar.html :: title-bar(centerClass='search-title', titleText='ì±…ì´ ìˆëŠ” ë„ì„œê´€ ì°¾ê¸°')}"></div>
	    <p class="sr-only">ë„ì„œ ê²€ìƒ‰ìœ¼ë¡œ ì›í•˜ëŠ” ì±…ì„ ì†Œì¥í•œ ë„ì„œê´€ì„ ì°¾ê³ , ëŒ€ì¶œ ê°€ëŠ¥ ì—¬ë¶€ë„ ì‰½ê²Œ í™•ì¸í•´ë³´ì„¸ìš”.</p>
	    <div class="top-right"></div>
	</div>
	<div id="notice">
	    ì›í•˜ëŠ” ì±…ì´ ìˆëŠ” ë„ì„œê´€, ëŒ€ì¶œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸í•´ë³´ì„¸ìš”.
	    <br><br>
	    ë„ì„œ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰, ì§€ì—­ì„ ì„ íƒ
	    <br><br>
	    (ISBN ì§ì ‘ ì…ë ¥ìœ¼ë¡œ ê²€ìƒ‰í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.)
        <br><br>
        ë°ì´í„° ì¶œì²˜ : <a href="https://www.data4library.kr/" target="_blank">ë„ì„œê´€ ì •ë³´ë‚˜ë£¨ API</a>, <a href="https://developers.naver.com/main/" target="_blank">ë„¤ì´ë²„ API</a>
    </div>

    <form id="searchForm">
	    <div class="form-group">
	        <label for="keyword">ë„ì„œ í‚¤ì›Œë“œ</label>
	        <div style="display: flex;">
	            <input type="text" id="keyword" class="book-search-input" placeholder="ë„ì„œëª… ë˜ëŠ” ì €ì ì…ë ¥" style="flex: 1; margin-right: 0px;">
	            <button type="button" onclick="searchBookByKeyword()" class="loan-check-btn">ğŸ”</button>
	        </div>
	    </div>    
	    <div class="form-group">
	        <label for="isbn">ISBN</label>
	        <input type="text" id="isbn" class="book-search-input" name="isbn" placeholder="ê²€ìƒ‰ ì‹œ ìë™ì…ë ¥ë¨" th:value="${isbn}" required>
	    </div>
        <div class="form-group">
			<label for="searchLibRegion">ê²€ìƒ‰ ì§€ì—­</label>
			<select id="regionCd" name="regionCd" th:value="${region}">
			    <option value="">ì§€ì—­</option>
			</select>
			
			<select id="dtlRegionCd" name="dtlRegionCd" th:value="${dtlRegion}">
			    <option value="">ì„¸ë¶€ì§€ì—­</option>
			</select>
		</div>
        <div class="form-group" style="text-align: center;">
            <input type="submit" value="ê²€ìƒ‰">
        </div>
    </form>

    <div id="lib-result-table"></div>
</div>

<!-- ë¡œë”©ë°” -->
<div id="loadingBar">
    <div></div>
</div>

<div id="bookSearchModal">
	<div class="loan-modal-header">
		<h3 id="modalTitle">ë„ì„œ ê²€ìƒ‰ ê²°ê³¼</h3>
		<span onclick="closeBookModal()" class="loan-modal-close">&times;</span>
	</div>
	<p class="loan-info-note" style="margin-top: 10px;">ğŸ”” <strong>ì°¾ê³ ì í•˜ëŠ” ì±…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</strong></p>
    <div id="bookListArea"></div>
</div>

<script th:inline="javascript">
    // ì„œë²„ì—ì„œ ë„˜ì–´ì˜¨ regionList : List<JsCode> í˜•ì‹
    const regionData = [[${regionList}]];

    const regionCdSelect = document.getElementById('regionCd');
    const dtlRegionCdSelect = document.getElementById('dtlRegionCd');

    const selectedRegion = /*[[${region}]]*/ '';  // ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë„˜ê¸´ ì§€ì—­ ê°’
    const selectedDtlRegion = /*[[${dtlRegion}]]*/ '';  // ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë„˜ê¸´ ì„¸ë¶€ì§€ì—­ ê°’

    // ìƒìœ„ ì§€ì—­(ì¤‘ë³µ ì œê±°) ë¡œë”©
    const regionMap = new Map();
    regionData.forEach(item => {
        if (!regionMap.has(item.regionCd)) {
            regionMap.set(item.regionCd, item.regionNm);
        }
    });

    for (const [code, name] of regionMap.entries()) {
        const opt = document.createElement('option');
        opt.value = code;
        opt.textContent = name;
        if (code === selectedRegion) {
            opt.selected = true; // ì´ë¯¸ ì„ íƒëœ ê°’ì´ë©´ ì„ íƒ ì²˜ë¦¬
        }
        regionCdSelect.appendChild(opt);
    }

    // ìƒìœ„ ì§€ì—­ ì„ íƒ ì‹œ í•˜ìœ„ ì§€ì—­ ë³€ê²½
    regionCdSelect.addEventListener('change', function () {
        const selectedRegionCd = this.value;
        dtlRegionCdSelect.innerHTML = '<option value="">ì„¸ë¶€ì§€ì—­</option>';

        regionData
            .filter(item => item.regionCd === selectedRegionCd)
            .forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.dtlRegionCd;
                opt.textContent = item.dtlRegionNm;
                if (item.dtlRegionCd === selectedDtlRegion) {
                    opt.selected = true; // ì´ë¯¸ ì„ íƒëœ ì„¸ë¶€ì§€ì—­ì´ë©´ ì„ íƒ ì²˜ë¦¬
                }
                dtlRegionCdSelect.appendChild(opt);
            });
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì„¸ë¶€ì§€ì—­ ë¡œë“œ
    regionCdSelect.dispatchEvent(new Event('change'));
</script>
</body>
</html>
