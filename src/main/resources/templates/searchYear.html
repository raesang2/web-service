<!DOCTYPE html>
<html lang="ko">
<head>
    <th:block th:replace="~{common.html}"></th:block>
    <meta property="og:type" content="website"> 
    <meta property="og:title" content="ì—°ë„ë³„ ì´ë¦„ ìˆœìœ„"> 
    <meta property="og:description" content="ì—°ë„ë³„ ì´ë¦„ ìˆœìœ„ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”">
    <meta property="og:url" content="https://kkidslife.com/searchYearPage">
    <title>ì—°ë„ë³„ ì´ë¦„ ìˆœìœ„ | kkidslife.com</title>
    <script>
    let offset = 50;  // ì´ˆê¸° 50ê°œ ë¡œë“œ
    let limit = 50;   // í•œ ë²ˆì— ë¡œë“œí•  ë°ì´í„° ê°œìˆ˜
    
        document.addEventListener('DOMContentLoaded', function() {
            // í¼ ì œì¶œ ì „ fromYearì™€ toYearì˜ ê°’ ìˆœì„œê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸
            document.getElementById('searchForm').addEventListener('submit', function(event) {
                let formData = new FormData(document.getElementById('searchForm'));
                const fromYear = parseInt(document.getElementById('fromYear').value);
                const toYear = parseInt(document.getElementById('toYear').value);
                
                // fromYearê°€ toYearë³´ë‹¤ í° ê²½ìš° ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
                if (fromYear > toYear) {
                    alert("ì‹œì‘ ì—°ë„ëŠ” ì¢…ë£Œ ì—°ë„ë³´ë‹¤ í´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì—°ë„ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    event.preventDefault(); // í¼ ì œì¶œì„ ë§‰ìŒ
                    return;
                }

                // í¼ ì œì¶œì„ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬
                event.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë§‰ê¸°

                // ë¡œë”©ë°” í‘œì‹œ
                document.getElementById('loadingBar').style.display = 'flex';

                document.getElementById('offset').value = 0;
                document.getElementById('limit').value = 50;
                offset = 50;  // ì´ˆê¸° 50ê°œ ë¡œë“œ
                limit = 50;   // í•œ ë²ˆì— ë¡œë“œí•  ë°ì´í„° ê°œìˆ˜                
                // í¼ ë°ì´í„° ì¤€ë¹„
                let queryParams = new URLSearchParams(new FormData(document.getElementById('searchForm'))).toString();

                // fetch ìš”ì²­ ë³´ë‚´ê¸°
                fetch('/selectYearStatsPage?' + queryParams, {
                    method: 'GET'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();  // í…ìŠ¤íŠ¸ë¡œ ì‘ë‹µ ë°›ê¸° (HTMLë¡œ ì‘ë‹µ)
                })
                .then(html => {
                    document.getElementById('result-table').innerHTML = html;  // ë°›ì•„ì˜¨ HTMLë¡œ ê²°ê³¼ ì—…ë°ì´íŠ¸
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                })
                .finally(() => {
                    document.getElementById('loadingBar').style.display = 'none';  // ë¡œë”©ë°” ìˆ¨ê¸°ê¸°
                });
            });

            // íƒ­ í´ë¦­ ì‹œ ì„±ë³„ ë³€ê²½
            window.changeGender = function(gender) {
                document.getElementById('targetGender').value = gender; // ì„±ë³„ ê°’ ë³€ê²½
                // íƒ­ì˜ ìŠ¤íƒ€ì¼ì„ ì—…ë°ì´íŠ¸
                document.querySelectorAll('.gender-tab').forEach(function(tab) {
                    tab.classList.remove('active');
                });
                document.getElementById(gender).classList.add('active');

                // ì„±ë³„ì— ë”°ë¥¸ í…Œì´ë¸” í‘œì‹œ/ìˆ¨ê¸°ê¸°
                if (gender === 'T') {
                    document.getElementById('t-table').style.display = 'table';
                    document.getElementById('m-table').style.display = 'none';
                    document.getElementById('f-table').style.display = 'none';
                } else if (gender === 'M') {
                    document.getElementById('t-table').style.display = 'none';
                    document.getElementById('m-table').style.display = 'table';
                    document.getElementById('f-table').style.display = 'none';
                } else if (gender === 'F') {
                    document.getElementById('t-table').style.display = 'none';
                    document.getElementById('m-table').style.display = 'none';
                    document.getElementById('f-table').style.display = 'table';
                }
            }
        });



        function loadMoreResults() {
            document.getElementById("loadingBar").style.display = "flex";
            document.getElementById('loadMoreIcon').style.display = 'none';

            // ê²€ìƒ‰ í¼ì˜ offset ê°’ ì—…ë°ì´íŠ¸
            document.getElementById('offset').value = offset;

            // GET ìš”ì²­ì„ ë³´ë‚¼ ë•Œ íŒŒë¼ë¯¸í„°ë¡œ formDataë¥¼ ì „ë‹¬ (ëª…ì‹œì ìœ¼ë¡œ URLì— query parameterë¡œ ì „ì†¡)
            let formData = new FormData(document.getElementById('searchForm'));
            let queryParams = new URLSearchParams(formData).toString();

            fetch('/api/getMoreYearStats?' + queryParams)  // GET ìš”ì²­
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();  // ì‘ë‹µì„ JSONìœ¼ë¡œ íŒŒì‹±
            })
            .then(data => {
            	console.log(data);  // ë°›ì•„ì˜¨ ë°ì´í„° í™•ì¸
                appendResultsToTable(data);  // ë°›ì€ ë°ì´í„°ë¥¼ í…Œì´ë¸”ì— ì¶”ê°€
                // offset ê°’ì„ ê°±ì‹ 
                offset += limit;
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            })
            .finally(() => {
                // ë¡œë”©ë°” ìˆ¨ê¸°ê³  ë²„íŠ¼ í™œì„±í™”
                document.getElementById("loadingBar").style.display = "none";
                document.getElementById('loadMoreIcon').style.display = 'flex';
            });
        }

        function appendResultsToTable(data) {
            // 1. tResults, mResults, fResults ë°›ì•„ì˜¤ê¸°
            const tResults = data.tResults;
            const mResults = data.mResults;
            const fResults = data.fResults;

            // 2. ê° tbodyì— ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
            const appendToTBody = (results, tbodyId) => {
                const tbody = document.getElementById(tbodyId);
                results.forEach(stat => {
                    const row = document.createElement('tr');
                    
                    // ìˆœìœ„, ì´ë¦„, ê±´ìˆ˜ì…€ ìƒì„±
                    const rankCell = document.createElement('td');
                    rankCell.textContent = stat.targetRank;
                    
                    const nameCell = document.createElement('td');
                    nameCell.textContent = stat.targetName;
                    
                    const countCell = document.createElement('td');
                    countCell.textContent = new Intl.NumberFormat().format(stat.targetCount);

                    // trì— tdë“¤ ì¶”ê°€
                    row.appendChild(rankCell);
                    row.appendChild(nameCell);
                    row.appendChild(countCell);
                    // total ì¼ ê²½ìš°ë§Œ ë¹„ìœ¨ ì»¬ëŸ¼ ì¶”ê°€
                    if(tbodyId == 't-tboby'){
                    
	                    const rateCell = document.createElement('td');
	                	rateCell.innerHTML = formatGenderRate(stat.mRate, stat.fRate); 
	                   	row.appendChild(rateCell);
                    }
                    
                    // tbodyì— ì¶”ê°€
                    tbody.appendChild(row);
                });
            };

            // 3. ê°ê°ì˜ ê²°ê³¼ë¥¼ tbodyì— append
            appendToTBody(tResults, 't-tboby');
            appendToTBody(mResults, 'm-tboby');
            appendToTBody(fResults, 'f-tboby');
        }        

        function formatGenderRate(mRate, fRate) {
        	  // ìˆ«ì ìë¦¬ìˆ˜ ë§ì¶”ê¸° (ê³µë°±ìœ¼ë¡œ)
        	  const mRateStr = mRate < 10 ? '&nbsp;&nbsp;' + mRate : (mRate < 100 ? '&nbsp;' + mRate : mRate);
        	  const fRateStr = fRate < 10 ? '&nbsp;&nbsp;' + fRate : (fRate < 100 ? '&nbsp;' + fRate : fRate);

        	  return `<span class="mfratio">ğŸ¤´ ${mRateStr}% ğŸ‘¸ ${fRateStr}%</span>`;
        }
    </script>
</head>
<body>
<div class="tbody">
	<div class="container">
		<div class="top-bar">
		    <div class="top-left" th:replace="~{nav.html}"></div>
		    <div class="top-center" th:replace="~{titlebar.html :: title-bar(centerClass='search-title', titleText='ì—°ë„ë³„ ê²€ìƒ‰')}"></div>
		    <div class="top-right"></div> <!-- ì¶”í›„ ë²„íŠ¼ ë“± ìœ„ì¹˜ìš© -->
		</div>
	   	<div th:replace="~{notice.html}"></div>
	   	
	    <!-- ê²€ìƒ‰ í¼ -->
	    <form id="searchForm">
	        <div class="form-group">
	            <label for="searchYear">ê²€ìƒ‰ì—°ë„</label>
	            <select id="fromYear" name="fromTargetYear" class="searchYear" required>
	                <option value="">ì‹œì‘</option>
	                <option th:each="year : ${yearList}" th:value="${year}" th:text="${year}"></option>
	            </select>
	            <select id="toYear" name="toTargetYear" class="searchYear" required>
	                <option value="">ë</option>
	                <option th:each="year : ${yearList}" th:value="${year}" th:text="${year}"></option>
	            </select>
	            <input type="hidden" id="targetGender" name="targetGender" value="T">
	            <input type="hidden" id="offset" name="offset" value="0">
	            <input type="hidden" id="limit" name="limit" value="50">
	        </div>
	        <div class="form-group" style="text-align: center;">
	            <input type="submit" value="ê²€ìƒ‰">
	        </div>
	    </form>
	
	    <div id="result-table">
	        <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
	    </div>
	</div>
	<div th:replace="~{footer :: footer}"></div>
</div>
<!-- ë¡œë”©ë°” -->
<div id="loadingBar">
    <div></div>
</div>
</body>
</html>
